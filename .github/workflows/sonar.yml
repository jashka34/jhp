name: Sonar check
on:
  push:
    branches: [master, '**']
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  branch-naming-rules:
    name: Show gh ref names
    runs-on: ubuntu-latest
    steps:
      - name: Echo gh ref names
        run: |
          echo "GITHUB_SHA="$GITHUB_SHA
          echo "GITHUB_REF="$GITHUB_REF
          echo "GITHUB_BASE_REF="$GITHUB_BASE_REF
          echo "GITHUB_EVENT_NAME="$GITHUB_EVENT_NAME
          echo "github.event_name="${{ github.event_name }}
      - uses: deepakputhraya/action-branch-name@master
        with:
          #          regex: '([a-z])+\/([a-z])+' # Regex the branch should match. This example enforces grouping
          allowed_prefixes: 'feature,stable,fix' # All branches should start with the given prefix
          ignore: master,develop # Ignore exactly matching branch names from convention
          min_length: 5 # Min length of the branch name
          max_length: 20 # Max length of the branch name
  label-check:
    runs-on: ubuntu-latest
    name: Label check
    steps:
      - name: Check labels
        if: ${{ github.event_name == 'pull_request' }}
        uses: zwaldowski/match-label-action@v2
        with:
          allowed: 'type:fix, type:features, type:documentation, type:tests, type:config'
  sonar-testing:
    needs: [branch-naming-rules, label-check]
    name: Mvn sonar verify
    runs-on: ubuntu-latest
    if: github.GITHUB_BASE_REF == 'master'
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Set up JDK 17
        uses: actions/setup-java@v1
        with:
          java-version: 17
      - name: Cache SonarCloud packages
        uses: actions/cache@v1
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache Maven packages
        uses: actions/cache@v1
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      - name: Show branch ref data
        run: |
          echo "GITHUB_SHA="$GITHUB_SHA
          echo "GITHUB_REF="$GITHUB_REF
          echo "GITHUB_BASE_REF="$GITHUB_BASE_REF
          echo "mvn project ver="$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
      - name: Build and analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -B clean verify sonar:sonar 
          -Dsonar.qualitygate.wait=true 
          -Dsonar.login=$SONAR_TOKEN 
          -Dsonar.projectKey=jashka34_jhp 
          -Dsonar.coverage.jacoco.xmlReportPaths=./target/site/jacoco/jacoco.xml
#      - name: ls-s
#        run: |
#          ls -lah target
#          ls -lah target/site/jacoco
